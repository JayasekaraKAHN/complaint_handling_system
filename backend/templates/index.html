<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Complaint Solution</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Bootstrap CSS for better styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <!-- Chart.js for usage graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Three-compartment layout styles */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr 420px;
            gap: 20px;
            min-height: calc(100vh - 100px);
            margin-top: 20px;
        }
        
        .left-compartment {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .middle-compartment {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .right-compartment {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
            min-width: 400px;
        }
        
        /* Responsive design */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
        }
        
        .header-nav {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <!-- Navigation Header -->
        <div class="header-nav">
            <nav class="main-nav">
                <a href="/" class="nav-link active">üè† Home</a>
                <a href="/dashboard" class="nav-link">üìä MSISDN Dashboard</a>
                <a href="/msisdn_details" class="nav-link">üì± MSISDN Details</a>
            </nav>
        </div>

        <!-- Three-compartment layout -->
        <div class="main-layout">
            
            <!-- Left Compartment: MSISDN Search -->
            <div class="left-compartment">
                <h4>üì± MSISDN Lookup</h4>
                <form id="msisdnSearchForm">
                    <div class="form-group mb-3">
                        <label for="search_msisdn" class="form-label">MSISDN:</label>
                        <input type="text" id="search_msisdn" name="search_msisdn" 
                               class="form-control"
                               placeholder="e.g., 94771234567" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">üîç Search Details</button>
                </form>
                
                <!-- Search Status -->
                <div id="searchStatus" class="mt-3"></div>
            </div>

            <!-- Middle Compartment: Original Complaint Form -->
            <div class="middle-compartment">
                <h2>üîß Complaint Solution System</h2>
                <p class="subtitle">AI-powered complaint resolution using pattern analysis and Ollama LLM</p>

                <form id="complaintForm" method="post" action="/get_solution">
                    <!-- Required Fields -->
                    <div class="form-group">
                        <label for="msisdn">MSISDN</label>
                        <input type="text" id="msisdn" name="msisdn" placeholder="Enter customer mobile number">
                        <div class="field-description">Customer's mobile number (optional)</div>
                    </div>

                    <div class="form-group">
                        <label for="complaint">Issue Description <span class="required">*</span></label>
                        <textarea id="complaint" name="complaint" required
                            placeholder="Describe the issue or complaint in detail"></textarea>
                        <div class="field-description">Brief description of the problem</div>
                    </div>

                    <!-- Technical Details Section -->
                    <div class="section-header">üìã Technical Details</div>

                    <div class="form-group">
                        <label for="device_type_settings_vpn_apn">Device / Settings / VPN / APN</label>
                        <input type="text" id="device_type_settings_vpn_apn" name="device_type_settings_vpn_apn"
                            placeholder="e.g., Android Phone, iPhone, Router, VPN settings">
                        <div class="field-description">Device model, configuration, or network settings</div>
                    </div>

                    <div class="form-group">
                        <label for="signal_strength">Signal Strength</label>
                        <select id="signal_strength" name="signal_strength">
                            <option value="">Select signal strength</option>
                            <option value="Excellent">Excellent (4-5 bars)</option>
                            <option value="Good">Good (3-4 bars)</option>
                            <option value="Fair">Fair (2-3 bars)</option>
                            <option value="Weak">Weak (1-2 bars)</option>
                            <option value="No Signal">No Signal (0 bars)</option>
                        </select>
                        <div class="field-description">Current signal strength observed</div>
                    </div>

                    <div class="form-group">
                        <label for="quality_of_signal">Quality of Signal</label>
                        <select id="quality_of_signal" name="quality_of_signal">
                            <option value="">Select signal quality</option>
                            <option value="Clear">Clear - No issues</option>
                            <option value="Good">Good - Minor issues</option>
                            <option value="Fair">Fair - Some problems</option>
                            <option value="Poor">Poor - Frequent issues</option>
                            <option value="Intermittent">Intermittent - On/off problems</option>
                        </select>
                        <div class="field-description">Voice/data quality experienced</div>
                    </div>

                    <div class="form-group">
                        <label for="site_kpi_alarm">Site KPI / Alarm</label>
                        <input type="text" id="site_kpi_alarm" name="site_kpi_alarm"
                            placeholder="e.g., Site unavailability, KLPOR5, KLPET1, Cell outage">
                        <div class="field-description">Any network alarms or site issues reported</div>
                    </div>

                    <div class="form-group">
                        <label for="past_data_analysis">Past Data Analysis</label>
                        <textarea id="past_data_analysis" name="past_data_analysis" rows="2"
                            placeholder="Previous similar issues, patterns, or analysis"></textarea>
                        <div class="field-description">Historical context or previous troubleshooting</div>
                    </div>

                    <div class="form-group">
                        <label for="indoor_outdoor_coverage_issue">Coverage Issue Type</label>
                        <select id="indoor_outdoor_coverage_issue" name="indoor_outdoor_coverage_issue">
                            <option value="">Select coverage type</option>
                            <option value="Indoor">Indoor Coverage Issue</option>
                            <option value="Outdoor">Outdoor Coverage Issue</option>
                            <option value="Both">Both Indoor and Outdoor</option>
                            <option value="None">No Coverage Issue</option>
                        </select>
                        <div class="field-description">Where the issue occurs</div>
                    </div>

                    <!-- Location Information Section -->
                    <div class="section-header">üìç Location Information</div>

                    <div class="form-group">
                        <label for="location">Location (Area/City)</label>
                        <input type="text" id="location" name="location"
                            placeholder="e.g., Karachi, Lahore, Colombo, Downtown Area">
                        <div class="field-description">General area or city name</div>
                    </div>

                    <div class="form-group">
                        <label for="longitude">Longitude</label>
                        <input type="number" id="longitude" name="longitude" step="any" placeholder="e.g., 67.0104">
                        <div class="field-description">Precise longitude coordinate (if available)</div>
                    </div>

                    <div class="form-group">
                        <label for="latitude">Latitude</label>
                        <input type="number" id="latitude" name="latitude" step="any" placeholder="e.g., 24.8614">
                        <div class="field-description">Precise latitude coordinate (if available)</div>
                    </div>

                    <button type="submit" id="submitBtn" class="submit-btn">üîç Get Solution</button>
                </form>

                <div id="solution" class="solution"></div>

                <!-- Location Data Table -->
                <div>
                    <h3>Location Data</h3>
                    <table id="locationTable">
                        <thead>
                            <tr>
                                <th>Site Name</th>
                                <th>RSRP Range 1 (> -105dBm)</th>
                                <th>RSRP Range 2 (-105 to -110dBm)</th>
                                <th>RSRP Range 3 (-110 to -115dBm)</th>
                                <th>RSRP Below -115dBm</th>
                                <th>Distance (km)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here via JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="info-box">
                    <h4>ü§ñ Smart Complaint Resolution Logic</h4>

                    <ul>
                        <li><strong>Exact Match:</strong> Same complaint + same conditions ‚Üí Returns exact solution from dataset
                            (max 5 sentences)</li>
                        <li><strong>Pattern Analysis:</strong> Similar complaint + different conditions ‚Üí Analyzes historical
                            patterns</li>
                        <li><strong>New Complaint:</strong> Completely new issue ‚Üí Uses Ollama Llama 3.2 1B LLM with full
                            context</li>
                    </ul>

                    <div class="pro-tips">
                        <strong>üí° Tips:</strong><br>
                        ‚Ä¢ Required field: Issue Description<br>
                        ‚Ä¢ MSISDN and other fields are optional for better matching<br>
                        ‚Ä¢ System analyzes only provided information<br>
                        ‚Ä¢ More details = better solution accuracy
                    </div>
                </div>
            </div>

            <!-- Right Compartment: MSISDN Details -->
            <div class="right-compartment">
                <h4 id="msisdnDetailsHeader">üì± MSISDN Details</h4>
                <div id="msisdnDetailsContent">
                    <p class="text-muted">Search for an MSISDN on the left to view details here.</p>
                </div>
                
                <!-- Usage Graphs Container -->
                <div id="usageGraphsContainer" style="display: none;">
                    <hr class="my-3">
                    <h6 class="mb-3">üìä Usage Trends (Last 3 Months)</h6>
                    
                    <!-- Data Usage Chart -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <small class="text-muted"><strong>üì° Data Usage by Technology</strong></small>
                        </div>
                        <div class="card-body p-2">
                            <canvas id="miniDataChart" width="380" height="180"></canvas>
                        </div>
                    </div>
                    
                    <!-- Voice Usage Chart -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <small class="text-muted"><strong>üìû Voice Usage</strong></small>
                        </div>
                        <div class="card-body p-2">
                            <canvas id="miniVoiceChart" width="380" height="180"></canvas>
                        </div>
                    </div>
                    
                    <!-- SMS Usage Chart -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <small class="text-muted"><strong>üí¨ SMS Usage</strong></small>
                        </div>
                        <div class="card-body p-2">
                            <canvas id="miniSmsChart" width="380" height="180"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Global variables for charts
        let miniDataChart = null;
        let miniVoiceChart = null;
        let miniSmsChart = null;
        
        // Function to display usage graphs in the right compartment
        function displayUsageGraphs(usageData) {
            console.log('displayUsageGraphs called with:', usageData);
            
            const container = document.getElementById('usageGraphsContainer');
            if (!container) {
                console.error('usageGraphsContainer not found');
                return;
            }
            
            container.style.display = 'block';
            
            // Destroy existing charts if they exist
            if (miniDataChart) {
                miniDataChart.destroy();
                miniDataChart = null;
            }
            if (miniVoiceChart) {
                miniVoiceChart.destroy();
                miniVoiceChart = null;
            }
            if (miniSmsChart) {
                miniSmsChart.destroy();
                miniSmsChart = null;
            }
            
            // Common chart configuration for mini charts
            const miniChartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            display: true,
                            grid: {
                                display: true,
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            };
            
            // Mini Data Usage Chart
            const dataCtx = document.getElementById('miniDataChart').getContext('2d');
            try {
                miniDataChart = new Chart(dataCtx, {
                    ...miniChartConfig,
                    data: {
                        labels: usageData.months,
                        datasets: [
                            {
                                label: '2G Data (MB)',
                                data: usageData.volume_2g_mb,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: '3G Data (MB)',
                                data: usageData.volume_3g_mb,
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: '4G Data (MB)',
                                data: usageData.volume_4g_mb,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: '5G Data (MB)',
                                data: usageData.volume_5g_mb,
                                borderColor: 'rgb(153, 102, 255)',
                                backgroundColor: 'rgba(153, 102, 255, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }
                        ]
                    }
                });
                console.log('Data chart created successfully');
            } catch (error) {
                console.error('Error creating data chart:', error);
            }
            
            // Mini Voice Usage Chart
            const voiceCtx = document.getElementById('miniVoiceChart').getContext('2d');
            try {
                miniVoiceChart = new Chart(voiceCtx, {
                    ...miniChartConfig,
                    data: {
                        labels: usageData.months,
                        datasets: [
                            {
                                label: 'Outgoing (min)',
                                data: usageData.outgoing_voice,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: 'Incoming (min)',
                                data: usageData.incoming_voice,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }
                        ]
                    }
                });
                console.log('Voice chart created successfully');
            } catch (error) {
                console.error('Error creating voice chart:', error);
            }
            
            // Mini SMS Usage Chart
            const smsCtx = document.getElementById('miniSmsChart').getContext('2d');
            try {
                miniSmsChart = new Chart(smsCtx, {
                    ...miniChartConfig,
                    data: {
                        labels: usageData.months,
                        datasets: [
                            {
                                label: 'Outgoing SMS',
                                data: usageData.outgoing_sms,
                                borderColor: 'rgb(153, 102, 255)',
                                backgroundColor: 'rgba(153, 102, 255, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: 'Incoming SMS',
                                data: usageData.incoming_sms,
                                borderColor: 'rgb(255, 159, 64)',
                                backgroundColor: 'rgba(255, 159, 64, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }
                        ]
                    }
                });
                console.log('SMS chart created successfully');
            } catch (error) {
                console.error('Error creating SMS chart:', error);
            }
        }

        // Function to fetch and display location data for MSISDN
        async function fetchLocationData(msisdn) {
            try {
                const response = await fetch(`/api/msisdn_dashboard?msisdn=${encodeURIComponent(msisdn)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.result && data.result.Common_Locations) {
                        displayLocationData(data.result.Common_Locations);
                    }
                }
            } catch (error) {
                console.error('Error fetching location data:', error);
            }
        }

        // Function to display location data in the details section
        function displayLocationData(locations) {
            const detailsContent = document.getElementById('msisdnDetailsContent');
            
            if (locations && locations.length > 0) {
                let locationHTML = `<div class="mb-4">`;
                locationHTML += `<h6>üìç Common Cell Locations</h6>`;
                
                locations.forEach((location, index) => {
                    locationHTML += `<div class="card mb-2">`;
                    locationHTML += `<div class="card-header py-1">`;
                    locationHTML += `<small><strong>${location.SITE_NAME || 'Unknown'} (${location.CELL_CODE || 'Unknown'})</strong></small>`;
                    locationHTML += `</div>`;
                    locationHTML += `<div class="card-body p-2">`;
                    locationHTML += `<div class="table-responsive">`;
                    locationHTML += `<table class="table table-sm table-borderless mb-0">`;
                    
                    // Basic information
                    locationHTML += `<tr><td style="width: 45%;"><small><strong>Cell Code:</strong></small></td><td><small>${location.CELL_CODE || 'Unknown'}</small></td></tr>`;
                    locationHTML += `<tr><td><small><strong>Site Name:</strong></small></td><td><small>${location.SITE_NAME || 'Unknown'}</small></td></tr>`;
                    if (location.SITE_NAME_LONG && location.SITE_NAME_LONG !== 'Unknown') {
                        locationHTML += `<tr><td><small><strong>Full Name:</strong></small></td><td><small>${location.SITE_NAME_LONG}</small></td></tr>`;
                    }
                    
                    // Location details
                    locationHTML += `<tr><td><small><strong>LAC:</strong></small></td><td><small>${location.LAC || 'Unknown'}</small></td></tr>`;
                    locationHTML += `<tr><td><small><strong>Cell ID:</strong></small></td><td><small>${location.CELL || 'Unknown'}</small></td></tr>`;
                    locationHTML += `<tr><td><small><strong>Coordinates:</strong></small></td><td><small>${location.LAT || 'N/A'}, ${location.LON || 'N/A'}</small></td></tr>`;
                    
                    // Geographic info
                    locationHTML += `<tr><td><small><strong>District:</strong></small></td><td><small>${location.DISTRICT || 'Unknown'}</small></td></tr>`;
                    locationHTML += `<tr><td><small><strong>Region:</strong></small></td><td><small>${location.REGION || 'Unknown'}</small></td></tr>`;
                    locationHTML += `<tr><td><small><strong>Province:</strong></small></td><td><small>${location.PROVINCE || 'Unknown'}</small></td></tr>`;
                    
                    // Technical details
                    locationHTML += `<tr><td><small><strong>Technology:</strong></small></td><td><small><span class="badge bg-${location.TYPE === '2G' ? 'secondary' : location.TYPE === '3G' ? 'info' : location.TYPE === '4G' ? 'primary' : 'success'}">${location.TYPE || 'Unknown'}</span></small></td></tr>`;
                    locationHTML += `<tr><td><small><strong>Status:</strong></small></td><td><small><span class="badge bg-${location.STATUS && location.STATUS.trim() === 'S' ? 'success' : location.STATUS && location.STATUS.trim() === 'A' ? 'warning' : 'danger'}">${location.STATUS ? location.STATUS.trim() : 'Unknown'}</span></small></td></tr>`;
                    
                    if (location.BORE && location.BORE !== 'Unknown') {
                        locationHTML += `<tr><td><small><strong>Antenna Bore:</strong></small></td><td><small>${location.BORE}¬∞</small></td></tr>`;
                    }
                    
                    // Dates
                    if (location.ONAIR_DATE && location.ONAIR_DATE !== 'Unknown') {
                        locationHTML += `<tr><td><small><strong>On-Air Date:</strong></small></td><td><small>${new Date(location.ONAIR_DATE).toLocaleDateString()}</small></td></tr>`;
                    }
                    if (location.BTS_CONFIGURED_DATE && location.BTS_CONFIGURED_DATE !== 'Unknown') {
                        locationHTML += `<tr><td><small><strong>BTS Config Date:</strong></small></td><td><small>${new Date(location.BTS_CONFIGURED_DATE).toLocaleDateString()}</small></td></tr>`;
                    }
                    
                    locationHTML += `</table></div></div></div>`;
                });
                
                locationHTML += `</div>`;
                
                // Append to existing content
                detailsContent.innerHTML += locationHTML;
            }
        }

        // Function to fetch usage data for MSISDN
        async function fetchUsageData(msisdn) {
            try {
                console.log(`Fetching usage data for MSISDN: ${msisdn}`);
                const response = await fetch(`/api/msisdn_dashboard?msisdn=${encodeURIComponent(msisdn)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    if (data.result && data.result.Usage_Data) {
                        console.log('Usage data found:', data.result.Usage_Data);
                        displayUsageGraphs(data.result.Usage_Data);
                    } else {
                        console.log('No usage data in response');
                        // Hide usage graphs container if no data
                        document.getElementById('usageGraphsContainer').style.display = 'none';
                    }
                } else {
                    console.error('API response not OK:', response.status);
                    document.getElementById('usageGraphsContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching usage data:', error);
                document.getElementById('usageGraphsContainer').style.display = 'none';
            }
        }

        // MSISDN Search functionality
        document.getElementById('msisdnSearchForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            
            const msisdn = document.getElementById('search_msisdn').value;
            const statusDiv = document.getElementById('searchStatus');
            const detailsContent = document.getElementById('msisdnDetailsContent');
            const detailsHeader = document.getElementById('msisdnDetailsHeader');
            
            if (!msisdn) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Please enter an MSISDN</div>';
                return;
            }
            
            // Show loading state
            statusDiv.innerHTML = '<div class="alert alert-info">üîç Searching...</div>';
            detailsContent.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            
            try {
                const response = await fetch(`/msisdn_details?msisdn=${encodeURIComponent(msisdn)}`);
                
                if (response.ok) {
                    const html = await response.text();
                    
                    // Parse the response HTML to extract the result data
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Check if there's an error
                    const errorDiv = doc.querySelector('.alert-danger');
                    if (errorDiv) {
                        statusDiv.innerHTML = `<div class="alert alert-danger">${errorDiv.textContent}</div>`;
                        detailsContent.innerHTML = '<p class="text-muted">No details found for this MSISDN.</p>';
                        detailsHeader.textContent = 'üì± MSISDN Details';
                        return;
                    }
                    
                    // Extract subscriber information table
                    const subscriberSection = doc.querySelector('.data-card');
                    if (subscriberSection) {
                        statusDiv.innerHTML = '<div class="alert alert-success">‚úÖ Details found!</div>';
                        detailsHeader.textContent = `üì± Details: ${msisdn}`;
                        
                        // Create condensed view for the right compartment
                        const tables = doc.querySelectorAll('.data-card');
                        let detailsHTML = '';
                        
                        tables.forEach(section => {
                            const heading = section.querySelector('h3');
                            const tableRows = section.querySelectorAll('tr');
                            
                            if (heading && tableRows.length > 0) {
                                detailsHTML += `<div class="mb-4">`;
                                detailsHTML += `<h6>${heading.textContent}</h6>`;
                                detailsHTML += `<div class="table-responsive">`;
                                detailsHTML += `<table class="table table-sm table-borderless">`;
                                
                                tableRows.forEach(row => {
                                    const cells = row.querySelectorAll('td');
                                    if (cells.length === 2) {
                                        detailsHTML += `<tr><td style="width: 40%;"><small><strong>${cells[0].textContent}</strong></small></td><td><small>${cells[1].textContent}</small></td></tr>`;
                                    }
                                });
                                
                                detailsHTML += `</table></div></div>`;
                            }
                        });
                        
                        // Fetch and display location data via API instead of parsing HTML
                        fetchLocationData(msisdn);
                        
                        detailsContent.innerHTML = detailsHTML || '<p class="text-muted">Details found but could not parse content.</p>';
                        
                        // Also populate the complaint form MSISDN field
                        document.getElementById('msisdn').value = msisdn;
                        
                        // Get usage data via direct API call
                        fetchUsageData(msisdn);
                        
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-warning">No details found for this MSISDN</div>';
                        detailsContent.innerHTML = '<p class="text-muted">No details available.</p>';
                        detailsHeader.textContent = 'üì± MSISDN Details';
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Error searching MSISDN</div>';
                detailsContent.innerHTML = '<p class="text-muted">Error loading details.</p>';
                detailsHeader.textContent = 'üì± MSISDN Details';
                console.error('MSISDN search error:', error);
            }
        });

        // Form submission with enhanced UX
        document.getElementById('complaintForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            submitBtn.innerHTML = 'üîÑ Analyzing...';
            submitBtn.disabled = true;

            // Get form values
            const formData = {
                msisdn: document.getElementById('msisdn').value || null,
                complaint: document.getElementById('complaint').value,
                device_type_settings_vpn_apn: document.getElementById('device_type_settings_vpn_apn').value || null,
                signal_strength: document.getElementById('signal_strength').value || null,
                quality_of_signal: document.getElementById('quality_of_signal').value || null,
                site_kpi_alarm: document.getElementById('site_kpi_alarm').value || null,
                past_data_analysis: document.getElementById('past_data_analysis').value || null,
                indoor_outdoor_coverage_issue: document.getElementById('indoor_outdoor_coverage_issue').value || null,
                location: document.getElementById('location').value || null,
                longitude: document.getElementById('longitude').value ? parseFloat(document.getElementById('longitude').value) : null,
                latitude: document.getElementById('latitude').value ? parseFloat(document.getElementById('latitude').value) : null
            };

            const solutionDiv = document.getElementById('solution');
            solutionDiv.className = 'solution';
            solutionDiv.innerHTML = '';

            try {
                // Show loading state
                solutionDiv.innerHTML = '<div class="loading">ü§ñ Analyzing complaint and generating solution...</div>';
                solutionDiv.className = 'solution show';

                const response = await fetch('/api/solution', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.solutions) {
                    // Store solution data and redirect to solution template
                    const solutionData = {
                        solutions: data.solutions,
                        solution_type: data.solution_type,
                        complaint: formData
                    };
                    
                    // Store in localStorage for the solution template to access
                    localStorage.setItem('solutionData', JSON.stringify(solutionData));
                    
                    // Redirect to solution template
                    window.location.href = '/solution_template';
                    
                } else if (data.error) {
                    solutionDiv.innerHTML = `<strong>‚ùå Error:</strong> ${data.error}`;
                    solutionDiv.className = 'solution show';
                } else {
                    solutionDiv.innerHTML = `<strong>‚ö†Ô∏è No solution found.</strong>`;
                    solutionDiv.className = 'solution show';
                }

            } catch (err) {
                solutionDiv.innerHTML = '<strong>‚ùå Network Error:</strong> Unable to connect to the server. Please check if the system is running.';
                solutionDiv.className = 'solution show';
            } finally {
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }




            fetch(`/location/location_data?lat=${lat}&lon=${lon}`)
                .then(response => response.json())
                .then(data => {
                    const locationTableBody = document.querySelector('#locationTable tbody');
                    locationTableBody.innerHTML = '';
                    // Only show the unique nearest site by site_name
                    if (data.nearest_site && data.nearest_site.site_name) {
                        const nearest = data.nearest_site;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><b>${nearest.site_name} (Nearest)</b></td>
                            <td>${nearest.rsrp_range_1}</td>
                            <td>${nearest.rsrp_range_2}</td>
                            <td>${nearest.rsrp_range_3}</td>
                            <td>${nearest.rsrp_below_115}</td>
                            <td>${(nearest.distance_km / 1000).toFixed(2)} km</td>
                        `;
                        locationTableBody.appendChild(row);
                    } else {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td colspan="6">No nearby site found.</td>`;
                        locationTableBody.appendChild(row);
                    }
                })
                .catch(error => console.error('Error fetching nearest site data:', error));



        });
    </script>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>