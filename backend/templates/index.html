<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Complaint Solution</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <div class="container">
        <nav class="main-nav">
            <a href="/" class="nav-link active">üè† Home</a>
            <a href="/dashboard" class="nav-link">üìä MSISDN Dashboard</a>
            <a href="/msisdn_details" class="nav-link">üì± MSISDN Details</a>
        </nav>
        <h2>üîß Complaint Solution System</h2>
        <p class="subtitle">AI-powered complaint resolution using pattern analysis and Ollama LLM</p>

        <form id="complaintForm" method="post" action="/get_solution">
            <!-- Required Fields -->
            <div class="form-group">
                <label for="msisdn">MSISDN</label>
                <input type="text" id="msisdn" name="msisdn" placeholder="Enter customer mobile number">
                <div class="field-description">Customer's mobile number (optional)</div>
            </div>

            <div class="form-group">
                <label for="complaint">Issue Description <span class="required">*</span></label>
                <textarea id="complaint" name="complaint" required
                    placeholder="Describe the issue or complaint in detail"></textarea>
                <div class="field-description">Brief description of the problem</div>
            </div>

            <!-- Technical Details Section -->
            <div class="section-header">üìã Technical Details</div>

            <div class="form-group">
                <label for="device_type_settings_vpn_apn">Device / Settings / VPN / APN</label>
                <input type="text" id="device_type_settings_vpn_apn" name="device_type_settings_vpn_apn"
                    placeholder="e.g., Android Phone, iPhone, Router, VPN settings">
                <div class="field-description">Device model, configuration, or network settings</div>
            </div>

            <div class="form-group">
                <label for="signal_strength">Signal Strength</label>
                <select id="signal_strength" name="signal_strength">
                    <option value="">Select signal strength</option>
                    <option value="Excellent">Excellent (4-5 bars)</option>
                    <option value="Good">Good (3-4 bars)</option>
                    <option value="Fair">Fair (2-3 bars)</option>
                    <option value="Weak">Weak (1-2 bars)</option>
                    <option value="No Signal">No Signal (0 bars)</option>
                </select>
                <div class="field-description">Current signal strength observed</div>
            </div>

            <div class="form-group">
                <label for="quality_of_signal">Quality of Signal</label>
                <select id="quality_of_signal" name="quality_of_signal">
                    <option value="">Select signal quality</option>
                    <option value="Clear">Clear - No issues</option>
                    <option value="Good">Good - Minor issues</option>
                    <option value="Fair">Fair - Some problems</option>
                    <option value="Poor">Poor - Frequent issues</option>
                    <option value="Intermittent">Intermittent - On/off problems</option>
                </select>
                <div class="field-description">Voice/data quality experienced</div>
            </div>

            <div class="form-group">
                <label for="site_kpi_alarm">Site KPI / Alarm</label>
                <input type="text" id="site_kpi_alarm" name="site_kpi_alarm"
                    placeholder="e.g., Site unavailability, KLPOR5, KLPET1, Cell outage">
                <div class="field-description">Any network alarms or site issues reported</div>
            </div>

            <div class="form-group">
                <label for="past_data_analysis">Past Data Analysis</label>
                <textarea id="past_data_analysis" name="past_data_analysis" rows="2"
                    placeholder="Previous similar issues, patterns, or analysis"></textarea>
                <div class="field-description">Historical context or previous troubleshooting</div>
            </div>

            <div class="form-group">
                <label for="indoor_outdoor_coverage_issue">Coverage Issue Type</label>
                <select id="indoor_outdoor_coverage_issue" name="indoor_outdoor_coverage_issue">
                    <option value="">Select coverage type</option>
                    <option value="Indoor">Indoor Coverage Issue</option>
                    <option value="Outdoor">Outdoor Coverage Issue</option>
                    <option value="Both">Both Indoor and Outdoor</option>
                    <option value="None">No Coverage Issue</option>
                </select>
                <div class="field-description">Where the issue occurs</div>
            </div>

            <!-- Location Information Section -->
            <div class="section-header">üìç Location Information</div>

            <div class="form-group">
                <label for="location">Location (Area/City)</label>
                <input type="text" id="location" name="location"
                    placeholder="e.g., Karachi, Lahore, Colombo, Downtown Area">
                <div class="field-description">General area or city name</div>
            </div>

            <div class="form-group">
                <label for="longitude">Longitude</label>
                <input type="number" id="longitude" name="longitude" step="any" placeholder="e.g., 67.0104">
                <div class="field-description">Precise longitude coordinate (if available)</div>
            </div>

            <div class="form-group">
                <label for="latitude">Latitude</label>
                <input type="number" id="latitude" name="latitude" step="any" placeholder="e.g., 24.8614">
                <div class="field-description">Precise latitude coordinate (if available)</div>
            </div>

            <button type="submit" id="submitBtn" class="submit-btn">üîç Get Solution</button>
        </form>

        <div id="solution" class="solution"></div>

        <div id="solution" class="solution"></div>

        <!-- Location Data Table -->
        <div>
            <h3>Location Data</h3>
            <table id="locationTable">
                <thead>
                    <tr>
                        <th>Site Name</th>
                        <th>RSRP Range 1 (> -105dBm)</th>
                        <th>RSRP Range 2 (-105 to -110dBm)</th>
                        <th>RSRP Range 3 (-110 to -115dBm)</th>
                        <th>RSRP Below -115dBm</th>
                        <th>Distance (km)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated here via JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="info-box">
            <h4>ü§ñ Smart Complaint Resolution Logic</h4>

            <ul>
                <li><strong>Exact Match:</strong> Same complaint + same conditions ‚Üí Returns exact solution from dataset
                    (max 5 sentences)</li>
                <li><strong>Pattern Analysis:</strong> Similar complaint + different conditions ‚Üí Analyzes historical
                    patterns</li>
                <li><strong>New Complaint:</strong> Completely new issue ‚Üí Uses Ollama Llama 3.2 1B LLM with full
                    context</li>
            </ul>

            <div class="pro-tips">
                <strong>üí° Tips:</strong><br>
                ‚Ä¢ Required field: Issue Description<br>
                ‚Ä¢ MSISDN and other fields are optional for better matching<br>
                ‚Ä¢ System analyzes only provided information<br>
                ‚Ä¢ More details = better solution accuracy
            </div>
        </div>
    </div>

    <script>
        // Form submission with enhanced UX
        document.getElementById('complaintForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            submitBtn.innerHTML = 'üîÑ Analyzing...';
            submitBtn.disabled = true;

            // Get form values
            const formData = {
                msisdn: document.getElementById('msisdn').value || null,
                complaint: document.getElementById('complaint').value,
                device_type_settings_vpn_apn: document.getElementById('device_type_settings_vpn_apn').value || null,
                signal_strength: document.getElementById('signal_strength').value || null,
                quality_of_signal: document.getElementById('quality_of_signal').value || null,
                site_kpi_alarm: document.getElementById('site_kpi_alarm').value || null,
                past_data_analysis: document.getElementById('past_data_analysis').value || null,
                indoor_outdoor_coverage_issue: document.getElementById('indoor_outdoor_coverage_issue').value || null,
                location: document.getElementById('location').value || null,
                longitude: document.getElementById('longitude').value ? parseFloat(document.getElementById('longitude').value) : null,
                latitude: document.getElementById('latitude').value ? parseFloat(document.getElementById('latitude').value) : null
            };

            const solutionDiv = document.getElementById('solution');
            solutionDiv.className = 'solution';
            solutionDiv.innerHTML = '';

            try {
                // Show loading state
                solutionDiv.innerHTML = '<div class="loading">ü§ñ Analyzing complaint and generating solution...</div>';
                solutionDiv.className = 'solution show';

                const response = await fetch('/api/solution', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.solutions) {
                    // Store solution data and redirect to solution template
                    const solutionData = {
                        solutions: data.solutions,
                        solution_type: data.solution_type,
                        complaint: formData
                    };
                    
                    // Store in localStorage for the solution template to access
                    localStorage.setItem('solutionData', JSON.stringify(solutionData));
                    
                    // Redirect to solution template
                    window.location.href = '/solution_template';
                    
                } else if (data.error) {
                    solutionDiv.innerHTML = `<strong>‚ùå Error:</strong> ${data.error}`;
                    solutionDiv.className = 'solution show';
                } else {
                    solutionDiv.innerHTML = `<strong>‚ö†Ô∏è No solution found.</strong>`;
                    solutionDiv.className = 'solution show';
                }

            } catch (err) {
                solutionDiv.innerHTML = '<strong>‚ùå Network Error:</strong> Unable to connect to the server. Please check if the system is running.';
                solutionDiv.className = 'solution show';
            } finally {
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }




            fetch(`/location/location_data?lat=${lat}&lon=${lon}`)
                .then(response => response.json())
                .then(data => {
                    const locationTableBody = document.querySelector('#locationTable tbody');
                    locationTableBody.innerHTML = '';
                    // Only show the unique nearest site by site_name
                    if (data.nearest_site && data.nearest_site.site_name) {
                        const nearest = data.nearest_site;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><b>${nearest.site_name} (Nearest)</b></td>
                            <td>${nearest.rsrp_range_1}</td>
                            <td>${nearest.rsrp_range_2}</td>
                            <td>${nearest.rsrp_range_3}</td>
                            <td>${nearest.rsrp_below_115}</td>
                            <td>${(nearest.distance_km / 1000).toFixed(2)} km</td>
                        `;
                        locationTableBody.appendChild(row);
                    } else {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td colspan="6">No nearby site found.</td>`;
                        locationTableBody.appendChild(row);
                    }
                })
                .catch(error => console.error('Error fetching nearest site data:', error));



        });
    </script>
</body>

</html>