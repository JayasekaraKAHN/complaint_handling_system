<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Complaint Solution</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Bootstrap CSS for better styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <!-- Chart.js for usage graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Three-compartment layout styles */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr 420px;
            gap: 20px;
            min-height: calc(100vh - 100px);
            margin-top: 20px;
        }
        
        .left-compartment {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .middle-compartment {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .right-compartment {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
            min-width: 400px;
        }
        
        /* Responsive design */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
        }
        
        .header-nav {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        /* Solution overlay styles */
        #solutionOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        #solutionOverlay .overlay-content {
            position: relative;
            width: 90vw;
            height: 90vh;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        #solutionOverlay button.close-overlay {
            position: absolute;
            top: 18px;
            right: 24px;
            z-index: 10000;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 18px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
        }

        #solutionOverlay iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <!-- Navigation Header -->
        <!-- <div class="header-nav">
            <nav class="main-nav">
                <a href="/" class="nav-link active">üè† Home</a>
                <a href="/dashboard" class="nav-link">üìä MSISDN Dashboard</a>
                <a href="/msisdn_details" class="nav-link">üì± MSISDN Details</a>
            </nav>
        </div> -->

        <!-- Three-compartment layout -->
        <div class="main-layout">
            
            <!-- Left Compartment: Information -->
            <div class="left-compartment">
                <h4>ÔøΩ Instructions</h4>
                <div class="alert alert-info">
                    <h6>üì± MSISDN Lookup</h6>
                    <p>Enter an MSISDN in the complaint form and click "Get Solution" to automatically fetch both solution and subscriber details.</p>
                </div>
                <div class="alert alert-primary">
                    <h6>üîß Solution Generation</h6>
                    <p>Fill out the complaint form with issue details. Location and technical information help generate more accurate solutions.</p>
                </div>
                <div class="alert alert-success">
                    <h6>üìä Results Display</h6>
                    <p>Solutions and MSISDN details will be shown in an overlay window with interactive options.</p>
                </div>
            </div>

            <!-- Middle Compartment: Original Complaint Form -->
            <div class="middle-compartment">
                <h2>üîß Complaint Solution System</h2>
                <p class="subtitle">AI-powered complaint resolution using pattern analysis and Ollama LLM</p>

                <form id="complaintForm" method="post" action="/get_solution">
                    <!-- Required Fields -->
                    <div class="form-group">
                        <label for="msisdn">MSISDN</label>
                        <input type="text" id="msisdn" name="msisdn" placeholder="Enter customer mobile number">
                        <div class="field-description">Customer's mobile number (optional) - Subscriber details will be fetched automatically</div>
                    </div>

                    <div class="form-group">
                        <label for="complaint">Issue Description <span class="required">*</span></label>
                        <textarea id="complaint" name="complaint" required
                            placeholder="Describe the issue or complaint in detail"></textarea>
                        <div class="field-description">Brief description of the problem</div>
                    </div>

                    <!-- Technical Details Section -->
                    <div class="section-header">üìã Technical Details</div>

                    <div class="form-group">
                        <label for="device_type_settings_vpn_apn">Device / Settings / VPN / APN</label>
                        <input type="text" id="device_type_settings_vpn_apn" name="device_type_settings_vpn_apn"
                            placeholder="e.g., Android Phone, iPhone, Router, VPN settings">
                        <div class="field-description">Device model, configuration, or network settings</div>
                    </div>

                    <div class="form-group">
                        <label for="signal_strength">Signal Strength</label>
                        <input type="text" id="signal_strength" name="signal_strength"
                            placeholder="e.g., -85 dBm, 2 bars, Weak, etc.">
                        <div class="field-description">Current signal strength observed (in dBm, bars, or description)</div>
                    </div>

                    <div class="form-group">
                        <label for="quality_of_signal">Quality of Signal</label>
                        <select id="quality_of_signal" name="quality_of_signal">
                            <option value="">Select signal quality</option>
                            <option value="Clear">Clear - No issues</option>
                            <option value="Good">Good - Minor issues</option>
                            <option value="Fair">Fair - Some problems</option>
                            <option value="Poor">Poor - Frequent issues</option>
                            <option value="Intermittent">Intermittent - On/off problems</option>
                        </select>
                        <div class="field-description">Voice/data quality experienced</div>
                    </div>

                    <div class="form-group">
                        <label for="site_kpi_alarm">Site KPI / Alarm</label>
                        <input type="text" id="site_kpi_alarm" name="site_kpi_alarm"
                            placeholder="e.g., Site unavailability, KLPOR5, KLPET1, Cell outage">
                        <div class="field-description">Any network alarms or site issues reported</div>
                    </div>

                    <div class="form-group">
                        <label for="past_data_analysis">Past Data Analysis</label>
                        <textarea id="past_data_analysis" name="past_data_analysis" rows="2"
                            placeholder="Previous similar issues, patterns, or analysis"></textarea>
                        <div class="field-description">Historical context or previous troubleshooting</div>
                    </div>

                    <div class="form-group">
                        <label for="indoor_outdoor_coverage_issue">Coverage Issue Type</label>
                        <select id="indoor_outdoor_coverage_issue" name="indoor_outdoor_coverage_issue">
                            <option value="">Select coverage type</option>
                            <option value="Indoor">Indoor Coverage Issue</option>
                            <option value="Outdoor">Outdoor Coverage Issue</option>
                            <option value="Both">Both Indoor and Outdoor</option>
                            <option value="None">No Coverage Issue</option>
                        </select>
                        <div class="field-description">Where the issue occurs</div>
                    </div>

                    <!-- Location Information Section -->
                    <div class="section-header">üìç Location Information</div>

                    <div class="form-group">
                        <label for="location">Location (Area/City)</label>
                        <input type="text" id="location" name="location"
                            placeholder="e.g., Karachi, Lahore, Colombo, Downtown Area">
                        <div class="field-description">General area or city name</div>
                    </div>

                    <div class="form-group">
                        <label for="longitude">Longitude</label>
                        <input type="number" id="longitude" name="longitude" step="any" placeholder="e.g., 67.0104">
                        <div class="field-description">Precise longitude coordinate (if available)</div>
                    </div>

                    <div class="form-group">
                        <label for="latitude">Latitude</label>
                        <input type="number" id="latitude" name="latitude" step="any" placeholder="e.g., 24.8614">
                        <div class="field-description">Precise latitude coordinate (if available)</div>
                    </div>

                    <button type="submit" id="submitBtn" class="submit-btn" onclick="event.preventDefault(); handleGetSolution();">üîç Get Solution & MSISDN Details</button>
                </form>

                <div id="solution" class="solution"></div>

            </div>

            <!-- Right Compartment: MSISDN Details -->
            <div class="right-compartment">
                <h4 id="msisdnDetailsHeader">üì± MSISDN Details</h4>
                <div id="msisdnDetailsContent">
                    <div class="alert alert-info">
                        <h6>üîç How to View MSISDN Details</h6>
                        <p>1. Enter an MSISDN in the complaint form</p>
                        <p>2. Fill out the complaint details</p>
                        <p>3. Click "Get Solution" button</p>
                        <p>4. MSISDN details will appear in the solution overlay along with the solution</p>
                    </div>
                </div>
                
                <!-- Usage Graphs Container -->
                <div id="usageGraphsContainer" style="display: none;">
                    <hr class="my-3">
                    <h6 class="mb-3">üìä Usage Trends (Last 3 Months)</h6>
                    
                    <!-- Data Usage Chart -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <small class="text-muted"><strong>üì° Data Usage by Technology</strong></small>
                        </div>
                        <div class="card-body p-2">
                            <canvas id="miniDataChart" width="380" height="180"></canvas>
                        </div>
                    </div>
                    
                    <!-- Voice Usage Chart -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <small class="text-muted"><strong>üìû Voice Usage</strong></small>
                        </div>
                        <div class="card-body p-2">
                            <canvas id="miniVoiceChart" width="380" height="180"></canvas>
                        </div>
                    </div>
                    
                    <!-- SMS Usage Chart -->
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <small class="text-muted"><strong>üí¨ SMS Usage</strong></small>
                        </div>
                        <div class="card-body p-2">
                            <canvas id="miniSmsChart" width="380" height="180"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Solution Overlay Modal -->
    <div id="solutionOverlay">
        <div class="overlay-content">
            <button class="close-overlay" onclick="closeSolutionOverlay()">‚úñ Close</button>
            <iframe id="solutionOverlayFrame" src="/solution_template"></iframe>
        </div>
    </div>

    <script>
        // Global variables for charts
        let miniDataChart = null;
        let miniVoiceChart = null;
        let miniSmsChart = null;
        
        // Function to display usage graphs in the right compartment
        function displayUsageGraphs(usageData) {
            console.log('displayUsageGraphs called with:', usageData);
            
            const container = document.getElementById('usageGraphsContainer');
            if (!container) {
                console.error('usageGraphsContainer not found');
                return;
            }
            
            container.style.display = 'block';
            
            // Destroy existing charts if they exist
            if (miniDataChart) {
                miniDataChart.destroy();
                miniDataChart = null;
            }
            if (miniVoiceChart) {
                miniVoiceChart.destroy();
                miniVoiceChart = null;
            }
            if (miniSmsChart) {
                miniSmsChart.destroy();
                miniSmsChart = null;
            }
            
            // Common chart configuration for mini charts
            const miniChartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            display: true,
                            grid: {
                                display: true,
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            };
            
            // Mini Data Usage Chart
            const dataCtx = document.getElementById('miniDataChart').getContext('2d');
            try {
                miniDataChart = new Chart(dataCtx, {
                    ...miniChartConfig,
                    data: {
                        labels: usageData.months,
                        datasets: [
                            {
                                label: '2G Data (MB)',
                                data: usageData.volume_2g_mb,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: '3G Data (MB)',
                                data: usageData.volume_3g_mb,
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: '4G Data (MB)',
                                data: usageData.volume_4g_mb,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: '5G Data (MB)',
                                data: usageData.volume_5g_mb,
                                borderColor: 'rgb(153, 102, 255)',
                                backgroundColor: 'rgba(153, 102, 255, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }
                        ]
                    }
                });
                console.log('Data chart created successfully');
            } catch (error) {
                console.error('Error creating data chart:', error);
            }
            
            // Mini Voice Usage Chart
            const voiceCtx = document.getElementById('miniVoiceChart').getContext('2d');
            try {
                miniVoiceChart = new Chart(voiceCtx, {
                    ...miniChartConfig,
                    data: {
                        labels: usageData.months,
                        datasets: [
                            {
                                label: 'Outgoing (min)',
                                data: usageData.outgoing_voice,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: 'Incoming (min)',
                                data: usageData.incoming_voice,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }
                        ]
                    }
                });
                console.log('Voice chart created successfully');
            } catch (error) {
                console.error('Error creating voice chart:', error);
            }
            
            // Mini SMS Usage Chart
            const smsCtx = document.getElementById('miniSmsChart').getContext('2d');
            try {
                miniSmsChart = new Chart(smsCtx, {
                    ...miniChartConfig,
                    data: {
                        labels: usageData.months,
                        datasets: [
                            {
                                label: 'Outgoing SMS',
                                data: usageData.outgoing_sms,
                                borderColor: 'rgb(153, 102, 255)',
                                backgroundColor: 'rgba(153, 102, 255, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            },
                            {
                                label: 'Incoming SMS',
                                data: usageData.incoming_sms,
                                borderColor: 'rgb(255, 159, 64)',
                                backgroundColor: 'rgba(255, 159, 64, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }
                        ]
                    }
                });
                console.log('SMS chart created successfully');
            } catch (error) {
                console.error('Error creating SMS chart:', error);
            }
        }

        // Function to fetch and display location data for MSISDN
        async function fetchLocationData(msisdn) {
            try {
                const response = await fetch(`/api/msisdn_dashboard?msisdn=${encodeURIComponent(msisdn)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.result && data.result.Common_Locations) {
                        displayLocationData(data.result.Common_Locations);
                    }
                    if (data.result && data.result.VoLTE_Info) {
                        displayVoLTEInfo(data.result.VoLTE_Info);
                    }
                }
            } catch (error) {
                console.error('Error fetching location data:', error);
            }
        }

        // Function to display location data in the details section
        function displayLocationData(locations) {
            const detailsContent = document.getElementById('msisdnDetailsContent');
            
            if (locations && locations.length > 0) {
                let locationHTML = `<div class="mb-4">`;
                locationHTML += `<h6>üìç Common Cell Locations</h6>`;
                
                locations.forEach((location, index) => {
                    locationHTML += `<div class="card mb-2">`;
                    locationHTML += `<div class="card-header py-1">`;
                    locationHTML += `<small><strong>${location.SITE_NAME || 'Unknown'} (${location.CELL_CODE || 'Unknown'})</strong></small>`;
                    locationHTML += `</div>`;
                    locationHTML += `<div class="card-body p-2">`;
                    locationHTML += `<div class="table-responsive">`;
                    locationHTML += `<table class="table table-sm table-borderless mb-0">`;
                    
                    // Basic information
                    locationHTML += `<tr><td style="width: 45%;"><small><strong>Cell Code:</strong></small></td><td><small>${location.CELL_CODE || 'Unknown'}</small></td></tr>`;
                    locationHTML += `<tr><td><small><strong>Site Name:</strong></small></td><td><small>${location.SITE_NAME || 'Unknown'}</small></td></tr>`;
                    if (location.SITE_NAME_LONG && location.SITE_NAME_LONG !== 'Unknown') {
                        locationHTML += `<tr><td><small><strong>Full Name:</strong></small></td><td><small>${location.SITE_NAME_LONG}</small></td></tr>`;
                    }
                    
                    // Location details
                    locationHTML += `<tr><td><small><strong>LAC:</strong></small></td><td><small>${location.LAC || 'Unknown'}</small></td></tr>`;
                    locationHTML += `<tr><td><small><strong>Cell ID:</strong></small></td><td><small>${location.CELL || 'Unknown'}</small></td></tr>`;
                    locationHTML += `<tr><td><small><strong>Coordinates:</strong></small></td><td><small>${location.LAT || 'N/A'}, ${location.LON || 'N/A'}</small></td></tr>`;
                    
                    // Geographic info
                    locationHTML += `<tr><td><small><strong>District:</strong></small></td><td><small>${location.DISTRICT || 'Unknown'}</small></td></tr>`;
                    locationHTML += `<tr><td><small><strong>Region:</strong></small></td><td><small>${location.REGION || 'Unknown'}</small></td></tr>`;
                    locationHTML += `<tr><td><small><strong>Province:</strong></small></td><td><small>${location.PROVINCE || 'Unknown'}</small></td></tr>`;
                    
                    // Technical details
                    locationHTML += `<tr><td><small><strong>Technology:</strong></small></td><td><small><span class="badge bg-${location.TYPE === '2G' ? 'secondary' : location.TYPE === '3G' ? 'info' : location.TYPE === '4G' ? 'primary' : 'success'}">${location.TYPE || 'Unknown'}</span></small></td></tr>`;
                    locationHTML += `<tr><td><small><strong>Status:</strong></small></td><td><small><span class="badge bg-${location.STATUS && location.STATUS.trim() === 'S' ? 'success' : location.STATUS && location.STATUS.trim() === 'A' ? 'warning' : 'danger'}">${location.STATUS ? location.STATUS.trim() : 'Unknown'}</span></small></td></tr>`;
                    
                    if (location.BORE && location.BORE !== 'Unknown') {
                        locationHTML += `<tr><td><small><strong>Antenna Bore:</strong></small></td><td><small>${location.BORE}¬∞</small></td></tr>`;
                    }
                    
                    // Dates
                    if (location.ONAIR_DATE && location.ONAIR_DATE !== 'Unknown') {
                        locationHTML += `<tr><td><small><strong>On-Air Date:</strong></small></td><td><small>${new Date(location.ONAIR_DATE).toLocaleDateString()}</small></td></tr>`;
                    }
                    if (location.BTS_CONFIGURED_DATE && location.BTS_CONFIGURED_DATE !== 'Unknown') {
                        locationHTML += `<tr><td><small><strong>BTS Config Date:</strong></small></td><td><small>${new Date(location.BTS_CONFIGURED_DATE).toLocaleDateString()}</small></td></tr>`;
                    }
                    
                    locationHTML += `</table></div></div></div>`;
                });
                
                locationHTML += `</div>`;
                
                // Append to existing content
                detailsContent.innerHTML += locationHTML;
            }
        }

        // Function to display VoLTE provisioning information
        function displayVoLTEInfo(volteInfo) {
            const detailsContent = document.getElementById('msisdnDetailsContent');
            
            let volteHTML = `<div class="mb-4">`;
            volteHTML += `<h6>üìû VoLTE Provisioning Status</h6>`;
            volteHTML += `<div class="card">`;
            volteHTML += `<div class="card-body p-2">`;
            volteHTML += `<div class="table-responsive">`;
            volteHTML += `<table class="table table-sm table-borderless mb-0">`;
            
            if (volteInfo.volte_provisioned === true) {
                volteHTML += `<tr><td style="width: 45%;"><small><strong>VoLTE Status:</strong></small></td><td><small><span class="badge bg-success">‚úÖ Provisioned</span></small></td></tr>`;
                
                if (volteInfo.cell_code && volteInfo.cell_code !== 'Unknown') {
                    volteHTML += `<tr><td><small><strong>VoLTE Cell Code:</strong></small></td><td><small>${volteInfo.cell_code}</small></td></tr>`;
                }
                if (volteInfo.district && volteInfo.district !== 'Unknown') {
                    volteHTML += `<tr><td><small><strong>VoLTE District:</strong></small></td><td><small>${volteInfo.district}</small></td></tr>`;
                }
                if (volteInfo.prepos && volteInfo.prepos !== 'Unknown') {
                    volteHTML += `<tr><td><small><strong>VoLTE PrePos:</strong></small></td><td><small>${volteInfo.prepos}</small></td></tr>`;
                }
                if (volteInfo.sim_type && volteInfo.sim_type !== 'Unknown') {
                    volteHTML += `<tr><td><small><strong>VoLTE SIM Type:</strong></small></td><td><small>${volteInfo.sim_type}</small></td></tr>`;
                }
                if (volteInfo.tac && volteInfo.tac !== 'Unknown') {
                    volteHTML += `<tr><td><small><strong>VoLTE TAC:</strong></small></td><td><small>${volteInfo.tac}</small></td></tr>`;
                }
            } else {
                volteHTML += `<tr><td style="width: 45%;"><small><strong>VoLTE Status:</strong></small></td><td><small><span class="badge bg-danger">‚ùå Not Provisioned</span></small></td></tr>`;
                
                if (volteInfo.message) {
                    volteHTML += `<tr><td><small><strong>Note:</strong></small></td><td><small>${volteInfo.message}</small></td></tr>`;
                }
                if (volteInfo.error) {
                    volteHTML += `<tr><td><small><strong>Error:</strong></small></td><td><small class="text-muted">${volteInfo.error}</small></td></tr>`;
                }
            }
            
            volteHTML += `</table></div></div></div></div>`;
            
            // Append to existing content
            detailsContent.innerHTML += volteHTML;
        }

        // Function to fetch usage data for MSISDN
        async function fetchUsageData(msisdn) {
            try {
                console.log(`Fetching usage data for MSISDN: ${msisdn}`);
                const response = await fetch(`/api/msisdn_dashboard?msisdn=${encodeURIComponent(msisdn)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    if (data.result && data.result.Usage_Data) {
                        console.log('Usage data found:', data.result.Usage_Data);
                        displayUsageGraphs(data.result.Usage_Data);
                    } else {
                        console.log('No usage data in response');
                        // Hide usage graphs container if no data
                        document.getElementById('usageGraphsContainer').style.display = 'none';
                    }
                } else {
                    console.error('API response not OK:', response.status);
                    document.getElementById('usageGraphsContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching usage data:', error);
                document.getElementById('usageGraphsContainer').style.display = 'none';
            }
        }

        // Function to fetch and display MSISDN details in the right compartment
        async function fetchAndDisplayMSISDNDetails(msisdn) {
            const detailsContent = document.getElementById('msisdnDetailsContent');
            const detailsHeader = document.getElementById('msisdnDetailsHeader');
            
            // Show loading state
            detailsContent.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading MSISDN details...</p></div>';
            detailsHeader.textContent = `üì± Loading: ${msisdn}`;
            
            try {
                const response = await fetch(`/api/msisdn_dashboard?msisdn=${encodeURIComponent(msisdn)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('MSISDN API Response:', data);
                    
                    if (data.result) {
                        detailsHeader.textContent = `üì± Details: ${msisdn}`;
                        
                        // Create subscriber details HTML
                        let detailsHTML = '';
                        
                        // Basic subscriber information
                        if (data.result.subscriber_info) {
                            const subscriber = data.result.subscriber_info;
                            detailsHTML += `<div class="mb-4">`;
                            detailsHTML += `<h6>üë§ Subscriber Information</h6>`;
                            detailsHTML += `<div class="table-responsive">`;
                            detailsHTML += `<table class="table table-sm table-borderless">`;
                            
                            Object.entries(subscriber).forEach(([key, value]) => {
                                if (value && value !== 'Unknown') {
                                    const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    detailsHTML += `<tr><td style="width: 40%;"><small><strong>${displayKey}:</strong></small></td><td><small>${value}</small></td></tr>`;
                                }
                            });
                            
                            detailsHTML += `</table></div></div>`;
                        }
                        
                        detailsContent.innerHTML = detailsHTML || '<p class="text-muted">Basic details loaded.</p>';
                        
                        // Fetch and display location data
                        if (data.result.Common_Locations) {
                            displayLocationData(data.result.Common_Locations);
                        }
                        
                        // Fetch and display VoLTE info
                        if (data.result.VoLTE_Info) {
                            displayVoLTEInfo(data.result.VoLTE_Info);
                        }
                        
                        // Fetch and display usage data
                        if (data.result.Usage_Data) {
                            displayUsageGraphs(data.result.Usage_Data);
                        }
                        
                    } else {
                        detailsHeader.textContent = 'üì± MSISDN Details';
                        detailsContent.innerHTML = '<div class="alert alert-warning">No details found for this MSISDN</div>';
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error fetching MSISDN details:', error);
                detailsHeader.textContent = 'üì± MSISDN Details';
                detailsContent.innerHTML = '<div class="alert alert-danger">‚ùå Error loading MSISDN details</div>';
            }
        }

        // Form submission with enhanced UX
        document.getElementById('complaintForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            // Use the handleGetSolution function for unified processing
            await handleGetSolution();
        });

        // Solution overlay functions
        function openSolutionOverlay() {
            document.getElementById('solutionOverlay').style.display = 'flex';
        }

        function closeSolutionOverlay() {
            document.getElementById('solutionOverlay').style.display = 'none';
        }

        async function handleGetSolution() {
            // Get form values
            const formData = {
                msisdn: document.getElementById('msisdn').value || null,
                complaint: document.getElementById('complaint').value,
                device_type_settings_vpn_apn: document.getElementById('device_type_settings_vpn_apn').value || null,
                signal_strength: document.getElementById('signal_strength').value || null,
                quality_of_signal: document.getElementById('quality_of_signal').value || null,
                site_kpi_alarm: document.getElementById('site_kpi_alarm').value || null,
                past_data_analysis: document.getElementById('past_data_analysis').value || null,
                indoor_outdoor_coverage_issue: document.getElementById('indoor_outdoor_coverage_issue').value || null,
                location: document.getElementById('location').value || null,
                longitude: document.getElementById('longitude').value ? parseFloat(document.getElementById('longitude').value) : null,
                latitude: document.getElementById('latitude').value ? parseFloat(document.getElementById('latitude').value) : null
            };

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            const solutionDiv = document.getElementById('solution');
            
            submitBtn.innerHTML = 'üîÑ Analyzing...';
            submitBtn.disabled = true;
            
            // Show loading state in solution div
            solutionDiv.innerHTML = '<div class="loading">ü§ñ Analyzing complaint and generating solution...</div>';
            solutionDiv.className = 'solution show';

            try {
                // Fetch solution data
                const solutionResponse = await fetch('/api/solution', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const solutionData = await solutionResponse.json();

                if (solutionData.solutions) {
                    // If MSISDN is provided, fetch and display MSISDN details in the right compartment
                    if (formData.msisdn) {
                        await fetchAndDisplayMSISDNDetails(formData.msisdn);
                    }

                    // Prepare solution data for overlay
                    const overlayData = {
                        solutions: solutionData.solutions,
                        complaint: formData,
                        location_info: solutionData.location_info || null
                    };

                    // If MSISDN data was fetched, include it in overlay data
                    if (formData.msisdn) {
                        try {
                            const msisdnResponse = await fetch(`/api/msisdn_dashboard?msisdn=${encodeURIComponent(formData.msisdn)}`);
                            if (msisdnResponse.ok) {
                                const msisdnData = await msisdnResponse.json();
                                overlayData.msisdn_info = {
                                    msisdn: formData.msisdn,
                                    subscriber_data: msisdnData.result || null,
                                    common_locations: msisdnData.result?.Common_Locations || null,
                                    volte_info: msisdnData.result?.VoLTE_Info || null,
                                    usage_data: msisdnData.result?.Usage_Data || null
                                };
                            }
                        } catch (msisdnError) {
                            console.warn('Could not fetch MSISDN data for overlay:', msisdnError);
                        }
                    }

                    localStorage.setItem('solutionData', JSON.stringify(overlayData));
                    
                    // Clear the solution div and open overlay
                    solutionDiv.innerHTML = '';
                    solutionDiv.className = 'solution';
                    openSolutionOverlay();
                } else if (solutionData.error) {
                    solutionDiv.innerHTML = `<strong>‚ùå Error:</strong> ${solutionData.error}`;
                    solutionDiv.className = 'solution show';
                } else {
                    solutionDiv.innerHTML = `<strong>‚ö†Ô∏è No solution found.</strong>`;
                    solutionDiv.className = 'solution show';
                }
            } catch (err) {
                solutionDiv.innerHTML = '<strong>‚ùå Network Error:</strong> Unable to connect to the server. Please check if the system is running.';
                solutionDiv.className = 'solution show';
                console.error('Error in handleGetSolution:', err);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
    </script>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>