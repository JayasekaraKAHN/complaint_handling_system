<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSISDN Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* Navigation override for Bootstrap compatibility */
        .main-nav {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-link {
            text-decoration: none !important;
            color: #666 !important;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 2px solid transparent;
        }
        
        .nav-link:hover {
            color: #667eea !important;
            background-color: #f8f9ff;
            border-color: #667eea;
            transform: translateY(-1px);
        }
        
        .nav-link.active {
            color: #667eea !important;
            background-color: #f8f9ff;
            border-color: #667eea;
            font-weight: 600;
        }
        
        .dashboard-container {
            margin-top: 20px;
        }
        .search-form {
            display: flex;
            margin-bottom: 20px;
        }
        .search-form input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }
        .search-form button {
            padding: 8px 16px;
            border: none;
            background-color: #4CAF50;
            color: white;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        .loading-spinner {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error-message {
            color: #d9534f;
            padding: 10px;
            background-color: #f9f2f2;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .solution {
            margin: 15px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-left: 4px solid #4CAF50;
        }
        .cell-locations-section {
            margin-top: 30px;
        }
        .map-preview {
            height: 400px;
            border: 1px solid #ddd;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .tab-content {
            margin-top: 15px;
        }
        .rsrp-table th, .rsrp-table td {
            font-size: 0.85rem;
            vertical-align: middle;
        }
        .rsrp-site-cell {
            font-weight: bold;
            background-color: #f8f9fa;
        }
        .rsrp-site-id-cell {
            background-color: #f8f9fa;
        }
        .rsrp-quality-cell {
            text-align: center;
        }
        .rsrp-data-cell {
            text-align: center;
        }
        .rsrp-cell-name {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="main-nav">
            <a href="/" class="nav-link">üè† Home</a>
            <a href="/dashboard" class="nav-link active">üìä MSISDN Dashboard</a>
            <a href="/msisdn_details" class="nav-link">üì± MSISDN Details</a>
        </nav>
        <h2>üìä MSISDN Dashboard</h2>
        <p class="subtitle">Device, Location, and Usage Data Visualization</p>
        <form id="msisdnForm" class="search-form">
            <input type="text" id="msisdnInput" placeholder="Enter MSISDN..." required>
            <button type="submit" class="submit-btn">üîç Search</button>
        </form>
        
        <div id="solutionBox" class="solution"></div>
        <div id="dashboard-content" class="dashboard-container">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="infoTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">Subscriber Details</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location" type="button" role="tab" aria-controls="location" aria-selected="false">Location Map</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="graphs-tab" data-bs-toggle="tab" data-bs-target="#graphs" type="button" role="tab" aria-controls="graphs" aria-selected="false">Usage Graphs</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="rsrp-tab" data-bs-toggle="tab" data-bs-target="#rsrp" type="button" role="tab" aria-controls="rsrp" aria-selected="false">RSRP Data</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="lte-util-tab" data-bs-toggle="tab" data-bs-target="#lte-util" type="button" role="tab" aria-controls="lte-util" aria-selected="false">LTE Utilization</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="nearest-locations-tab" data-bs-toggle="tab" data-bs-target="#nearest-locations" type="button" role="tab" aria-controls="nearest-locations" aria-selected="false">Nearest Locations</button>
              </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="infoTabsContent">
              <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                <div class="card p-4 mt-3">
                  1. Subscriber Identification
                  <table class="table table-bordered">
                    <tr>
                      <td><strong>MSISDN:</strong></td>
                      <td>{{ result['MSISDN'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>IMSI:</strong></td>
                      <td>{{ result['IMSI'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>IMEI:</strong></td>
                      <td>{{ result['IMEI']}}</td>
                    </tr>
                  </table>

                  <br>
                  2. Device Information
                  <table class="table table-bordered">
                    <tr>
                      <td><strong>Device Manufacturer:</strong></td>
                      <td>{{ result['Brand']}}</td>
                    </tr>
                    <tr>
                      <td><strong>Model</strong></td>
                      <td>{{ result['Model'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>Device Type</strong></td>
                      <td>{{ result['Device Type'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>Primary Hardware Type</strong></td>
                      <td>{{ result['Primary Hardware Type'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>Year Released</strong></td>
                      <td>{{ result['Year Released'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>Operating System Version</strong></td>
                      <td>{{ result['OS'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>VoLTE Support</strong></td>
                      <td>{{ result['VoLTE'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>SIM Type</strong></td>
                      <td>{{ result['SIM Type'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>VoLTE-provisioning Status</strong></td> <!---->
                    </tr>
                  </table>
                  <br>

                  3. Location Data
                  <table class="table table-bordered">
                    <tr>
                      <td>Recent Cell Location</td>
                    </tr>
                    <tr>
                      <td><strong>Cell Code:</strong></td>
                      <td>{{ result['Cellcode'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>Site Name:</strong></td>
                      <td>{{ result['Sitename'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>Coordinates:</strong></td>
                      <td>Lat: {{ result['Lat'] }}, Lon: {{ result['Lon'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>Region:</strong></td>
                      <td>{{ result['Region'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>District:</strong></td>
                      <td>{{ result['District'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>LAC:</strong></td>
                      <td>{{ result['LAC'] }}</td>
                    </tr>
                    <tr>
                      <td><strong>Cell_ID:</strong></td>
                      <td>{{ result['SAC'] }}</td>
                    </tr>
                    {% if result["Common Cell Locations"] %}
                    {% for loc in result["Common Cell Locations"] %}
                    <tr>
                      <td>Common Cell Location</td>
                    </tr>
                    <tr>
                      <td><strong>Cell Code</strong></td>
                      <td>{{ loc.CELL_CODE }}</td>
                    </tr>
                    <tr>
                      <td><strong>Site Name</strong></td>
                      <td>{{ loc.SITE_NAME }}</td>
                    </tr>
                    <tr>
                      <td><strong>Coordinates:</strong></td>
                      <td>
                        {% if loc.LAT and loc.LON and loc.LAT != 'Not Found' and loc.LON != 'Not Found' %}
                        Lat: {{ loc.LAT }}, Lon: {{ loc.LON }}
                        {% else %}
                        Not Available
                        {% endif %}
                      </td>
                    </tr>
                    <tr>
                      <td><strong>District</strong></td>
                      <td>{{ loc.DISTRICT }}</td>
                    </tr>
                    <tr>
                      <td><strong>LAC</strong></td>
                      <td>{{ loc.LAC }}</td>
                    </tr>
                    <tr>
                      <td><strong>Cell_ID</strong></td>
                      <td>{{ loc.CELL }}</td>
                    </tr>
                    {% if not loop.last %}
                    <tr>
                      <td colspan="2" style="border-top: 2px solid #dee2e6;"></td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                    {% else %}
                    <tr>
                      <td><strong>Common Locations:</strong></td>
                      <td class="text-muted">No common locations found for this MSISDN.</td>
                    </tr>
                    {% endif %}
                  </table>

                  <br>
                </div>
              </div>


              <!-- Location Map Tab Content-->
              <div class="tab-pane fade" id="location" role="tabpanel" aria-labelledby="location-tab">
                <div class="card p-4 mt-3">
                  <div class="map-preview mb-3">
                    {% if has_map %}
                    <iframe src="{{ url_for('static', filename='temp_map.html') }}" width="100%" height="100%"
                      frameborder="0"></iframe>
                    {% else %}
                    <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                      <div class="text-center">
                        <p class="mb-2">Other regions map preview not available</p>
                        <small class="text-muted">Click "View Other Regions Map" to explore</small>
                      </div>
                    </div>
                    {% endif %}
                  </div>

                  <div class="d-flex gap-2 flex-wrap">
                    <a href="{{ url_for('show_map', msisdn=result.MSISDN) }}" class="btn btn-success" target="_blank">
                      View Full Map
                    </a>
                  </div>
                </div>
              </div>

              <div class="tab-pane fade" id="graphs" role="tabpanel" aria-labelledby="graphs-tab">
                <div id="usageGraph" class="mt-3">
                    <!-- Dash/Plotly graph will be embedded here -->
                    <iframe src="/usage-graph/" width="100%" height="600" frameborder="0"></iframe>
                </div>
              </div>
              
              <!-- Placeholder for other tab content sections -->
              <div class="tab-pane fade" id="rsrp" role="tabpanel" aria-labelledby="rsrp-tab">
                <div class="card p-4 mt-3">
                  <p class="text-center">RSRP Data will be displayed here.</p>
                </div>
              </div>
              
              <div class="tab-pane fade" id="lte-util" role="tabpanel" aria-labelledby="lte-util-tab">
                <div class="card p-4 mt-3">
                  <p class="text-center">LTE Utilization data will be displayed here.</p>
                </div>
              </div>
              
              <div class="tab-pane fade" id="nearest-locations" role="tabpanel" aria-labelledby="nearest-locations-tab">
                <div class="card p-4 mt-3">
                  <p class="text-center">Nearest locations data will be displayed here.</p>
                </div>
              </div>
            </div>
        </div>
    </div>
    
    <script>
        document.getElementById('msisdnForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const msisdn = document.getElementById('msisdnInput').value.trim();
            if (!msisdn) return;
            
            await fetchMsisdnData(msisdn);
        });
        
        async function fetchMsisdnData(msisdn) {
            showLoading();
            
            try {
                // Fetch dashboard data
                const dashResponse = await fetch(`/dashboard/api/msisdn_dashboard?msisdn=${encodeURIComponent(msisdn)}`);
                const data = await dashResponse.json();
                
                // Fetch solution in parallel
                const solutionPromise = fetch('/api/solution', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        msisdn: msisdn,
                        complaint: "General device information request"
                    })
                }).then(res => res.json());
                
                updateDashboard(data);
                
                // Handle solution display
                const solutionData = await solutionPromise;
                updateSolution(solutionData);
                
            } catch (err) {
                console.error('Error fetching data:', err);
                document.getElementById('dashboard-content').innerHTML = 
                    '<div class="error-message">‚ùå Error loading dashboard data. Please try again.</div>';
                document.getElementById('solutionBox').innerHTML = '';
            }
        }
        
        function showLoading() {
            document.getElementById('dashboard-content').classList.add('loading');
            document.getElementById('solutionBox').innerHTML = '<div class="loading-spinner">Loading data...</div>';
        }
        
        function updateDashboard(data) {
            if (!data || data.error) {
                document.getElementById('dashboard-content').innerHTML = '<div class="alert alert-danger"><strong>‚ùå Error:</strong> ' + (data.error || 'Unknown error loading data') + '</div>';
                return;
            }
            
            // Redirect to the MSISDN details page with the full data
            window.location.href = `/msisdn_details/${data.table[0].msisdn}`;
        }
        
        function updateCellLocations(cellLocations) {
            const cellLocationsSection = document.getElementById('cell-locations-section');
            const tbody = document.querySelector('#cellLocationsTable tbody');
            tbody.innerHTML = '';
            
            if (cellLocations && cellLocations.length > 0) {
                cellLocationsSection.style.display = 'block';
                
                cellLocations.forEach(cell => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${cell.cellid || '-'}</td>
                        <td>${cell.sitename || '-'}</td>
                        <td>${cell.cellcode || '-'}</td>
                        <td>${cell.type || '-'}</td>
                        <td>${cell.region || '-'}</td>
                        <td>${cell.district || '-'}</td>
                        <td>${cell.province || '-'}</td>
                        <td>${cell.status || '-'}</td>
                        <td>${cell.lat || '0'}, ${cell.lon || '0'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                cellLocationsSection.style.display = 'none';
            }
        }
        
        function updateSolution(data) {
            const solutionBox = document.getElementById('solutionBox');
            if (data.solution) {
                solutionBox.innerHTML = `<strong>üîß Device Information:</strong><br>${data.solution}`;
            } else if (data.error) {
                solutionBox.innerHTML = `<strong>‚ùå Error:</strong> ${data.error}`;
            } else {
                solutionBox.innerHTML = `<strong>‚ö†Ô∏è No information available.</strong>`;
            }
        }
    </script>
    
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js for the graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Initialize the tabs
        document.addEventListener('DOMContentLoaded', function() {
            // Create tab objects if Bootstrap is loaded
            if (typeof bootstrap !== 'undefined') {
                var tabElms = document.querySelectorAll('button[data-bs-toggle="tab"]');
                tabElms.forEach(function(tabElm) {
                    new bootstrap.Tab(tabElm);
                });
            }
        });
    </script>
</body>
</html>
